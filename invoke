#!/bin/bash
# Auto-activate virtual environment and run invoke commands
# This script ensures the virtual environment is active and dependencies are installed before running any invoke tasks

set -e  # Exit on any error

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Change to the script directory (repo root)
cd "$SCRIPT_DIR"

# Function to create and set up virtual environment
setup_venv() {
    echo "ðŸ”§ Virtual environment not found. Setting up..."
    
    # Check if Python 3 is available
    if ! command -v python3 &> /dev/null; then
        echo "âŒ Python 3 is not installed or not in PATH"
        exit 1
    fi
    
    # Create virtual environment
    echo "ðŸ Creating virtual environment..."
    python3 -m venv venv
    
    # Activate virtual environment
    echo "ðŸ”§ Activating virtual environment..."
    source venv/bin/activate
    
    # Upgrade pip
    echo "ðŸ“¦ Upgrading pip..."
    pip install --upgrade pip
    
    # Install requirements (prioritize dev requirements if available)
    if [ -f "requirements-dev.txt" ]; then
        echo "ðŸ“¦ Installing development dependencies from requirements-dev.txt..."
        pip install -r requirements-dev.txt
    elif [ -f "requirements.txt" ]; then
        echo "ðŸ“¦ Installing production dependencies from requirements.txt..."
        pip install -r requirements.txt
    else
        echo "âš ï¸  No requirements files found"
    fi
    
    # Install current package in development mode
    if [ -f "setup.py" ]; then
        echo "ðŸ“¦ Installing current package in development mode..."
        pip install -e .
    fi
    
    echo "âœ… Virtual environment setup complete!"
}

# Check if virtual environment exists
if [ ! -d "venv" ]; then
    setup_venv
else
    # Activate existing virtual environment
    echo "ðŸ”§ Activating existing virtual environment..." >&2
    source venv/bin/activate
fi

# Verify activation
if [ -z "$VIRTUAL_ENV" ]; then
    echo "âŒ Failed to activate virtual environment" >&2
    exit 1
fi

echo "âœ… Virtual environment activated: $VIRTUAL_ENV" >&2

# Run the invoke command with all arguments passed through
echo "ðŸš€ Running: invoke $*" >&2
exec invoke "$@"
